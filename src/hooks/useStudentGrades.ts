"use client"

import { useState, useCallback, useEffect } from "react"
import type { Student, FilterOptions, SearchOptions } from "../types/student"

const initialStudents: Student[] = []

export function useStudentGrades() {
  const [students, setStudents] = useState<Student[]>(initialStudents)
  const [filteredStudents, setFilteredStudents] = useState<Student[]>(initialStudents)
  const [filters, setFilters] = useState<FilterOptions>({
    academicYear: "",
    educationLevel: "",
    studySystem: "",
    subject: "",
    evaluationPeriod: "",
  })

  // ÿ•ÿ∂ÿßŸÅÿ© console.log ÿπŸÜÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
  const updateFilters = (newFilters: FilterOptions) => {
    console.log("üîç Updating filters from:", filters, "to:", newFilters)
    setFilters(newFilters)
  }

  // ÿ•ÿ∂ÿßŸÅÿ© console.log ŸÅŸä setFilters ÿßŸÑÿ£ÿµŸÑŸä
  const setFiltersWithLog = (newFilters: FilterOptions) => {
    console.log("üîç setFilters called with:", newFilters)
    setFilters(newFilters)
  }
  const [searchOptions, setSearchOptions] = useState<SearchOptions>({
    searchType: "name",
    searchValue: "",
    displayFilter: "all",
  })

  // ÿ≠ÿßŸÑÿ© popup ÿßŸÑÿ≠ŸÅÿ∏
  const [savePopup, setSavePopup] = useState<{
    show: boolean
    message: string
    subjectName: string
  }>({
    show: false,
    message: "",
    subjectName: ""
  })

  // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
  const isThirdPeriod = filters.evaluationPeriod === "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©"

  const mapPeriodToServer = (label: string): string => {
    switch (label) {
      case "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ":
        return "FIRST"
      case "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©":
        return "SECOND"
      case "ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©":
        return "THIRD"
      default:
        return ""
    }
  }

  const fetchSubjectGrades = useCallback(async () => {
    console.log("üîç fetchSubjectGrades called with filters:", filters)

    // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© ÿ≥Ÿàÿßÿ° ŸÉÿßŸÜ ŸÜÿµÿßŸã ÿ£Ÿà ŸÉÿßÿ¶ŸÜÿßŸã
    const getSubjectName = () => {
      if (typeof filters.subject === 'object' && filters.subject !== null) {
        return filters.subject.name
      }
      return filters.subject
    }

    const subjectName = getSubjectName()

    try {
      const params = new URLSearchParams({
        subject: subjectName,
        period: String(filters.evaluationPeriod),
        academicYear: String(filters.academicYear),
        educationLevel: String(filters.educationLevel || ""),
        studySystem: String(filters.studySystem || ""),
        searchType: String(searchOptions.searchType || ""),
        searchValue: String(searchOptions.searchValue || ""),
        displayFilter: String(searchOptions.displayFilter || ""),
      })
      console.log("üîç API params:", params.toString())
      const res = await fetch(`/api/subject-grades?${params.toString()}`)
      if (!res.ok) {
        setStudents([])
        return
      }
      const data = await res.json()
      console.log("üîç Raw API response:", data.students)
      const rows: Student[] = (data.students || []).map((r: any) => {
        console.log("üîç Processing student:", r)
        return {
          studentId: r.studentId,
          studentName: r.studentName,
          firstMonthGrade: r.firstMonthGrade,
          secondMonthGrade: r.secondMonthGrade,
          thirdMonthGrade: r.thirdMonthGrade,
          workTotal: r.workTotal,
          finalExamGrade: r.finalExamGrade,
          periodTotal: r.periodTotal,
          status: r.status,
          _dbStudentId: r._dbStudentId,
          // ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          academicYear: r.academicYear,
          studyLevel: r.studyLevel,
          studyMode: r.studyMode,
          specialization: r.specialization,
          birthday: r.birthday,
          address: r.address,
          studentPhone: r.studentPhone,
          guardianName: r.guardianName,
          guardianPhone: r.guardianPhone,
          enrollmentStatus: r.enrollmentStatus,
          studentStatus: r.studentStatus,
        }
      })
      console.log("üîç Processed students:", rows)
      setStudents(rows)
    } catch (e) {
      setStudents([])
    }
  }, [filters.subject, filters.evaluationPeriod, filters.academicYear, filters.educationLevel, filters.studySystem, searchOptions.searchType, searchOptions.searchValue, searchOptions.displayFilter])

  const calculateWorkTotal = useCallback(
    (first: number | null, second: number | null, third: number | null): number => {
      if (isThirdPeriod) {
        // ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©: month1 Ÿà month2 ŸáŸÖÿß ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ™ÿ±ÿ™ŸäŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ™ŸäŸÜ
        const firstPeriodTotal = first !== null ? first : 0
        const secondPeriodTotal = second !== null ? second : 0
        const total = firstPeriodTotal + secondPeriodTotal
        return total > 0 ? Math.round(total * 100) / 100 : 0
      } else {
        // ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ: ŸÜÿ≠ÿ≥ÿ® ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿßŸÑÿ´ŸÑÿßÿ´ÿ©
        const grades = [first, second, third].filter((grade) => grade !== null) as number[]
        if (grades.length === 0) return 0
        const total = grades.reduce((sum, grade) => sum + grade, 0) / grades.length
        return total > 0 ? Math.round(total * 100) / 100 : 0
      }
    },
    [isThirdPeriod],
  )

  const calculatePeriodTotal = useCallback(
    (workTotal: number, finalExam: number | null): number => {
      if (finalExam === null) return 0
      if (isThirdPeriod) {
        // ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©: ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ™ÿ±ÿ™ŸäŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ™ŸäŸÜ + ÿßŸÖÿ™ÿ≠ÿßŸÜ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©
        const total = workTotal + finalExam
        return total > 0 ? Math.round(total * 100) / 100 : 0
      } else {
        // ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ: ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿπÿ™ÿßÿØ (40% ÿ£ÿπŸÖÿßŸÑ + 60% ÿßŸÖÿ™ÿ≠ÿßŸÜ)
        const total = workTotal * 0.4 + finalExam * 0.6
        return total > 0 ? Math.round(total * 100) / 100 : 0
      }
    },
    [isThirdPeriod],
  )

  const persistSingle = useCallback(async (row: Student) => {
    console.log("üîç persistSingle called with filters:", filters)
    console.log("üîç persistSingle called with row:", row)

    if (!filters.subject || !filters.evaluationPeriod || !filters.academicYear) {
      console.log("‚ùå Cannot persist - missing filters:", {
        subject: filters.subject,
        evaluationPeriod: filters.evaluationPeriod,
        academicYear: filters.academicYear
      })
      return
    }

    // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© ÿ≥Ÿàÿßÿ° ŸÉÿßŸÜ ŸÜÿµÿßŸã ÿ£Ÿà ŸÉÿßÿ¶ŸÜÿßŸã
    const getSubjectName = () => {
      if (typeof filters.subject === 'object' && filters.subject !== null) {
        return filters.subject.name
      }
      return filters.subject
    }

    const subjectName = getSubjectName()

    console.log("üíæ Persisting student grades:", {
      studentId: row.studentId,
      studentName: row.studentName,
      subject: subjectName,
      academicYear: filters.academicYear,
      period: filters.evaluationPeriod,
      month1: row.firstMonthGrade,
      month2: row.secondMonthGrade,
      month3: isThirdPeriod ? null : row.thirdMonthGrade, // ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©: month3 = null
      finalExam: row.finalExamGrade
    })

    try {
      const response = await fetch("/api/subject-grades", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subject: subjectName,
          academicYear: filters.academicYear,
          period: filters.evaluationPeriod,
          studentDbId: row._dbStudentId || row.studentId,
          month1: row.firstMonthGrade || null,
          month2: row.secondMonthGrade || null,
          month3: isThirdPeriod ? null : (row.thirdMonthGrade || null),
          finalExam: row.finalExamGrade || null,
        }),
      })

      if (response.ok) {
        const data = await response.json()
        console.log("‚úÖ Grades saved successfully:", data)
        // ÿ•ÿ∏Ÿáÿßÿ± popup ÿßŸÑŸÜÿ¨ÿßÿ≠
        setSavePopup({
          show: true,
          message: data.message || "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠",
          subjectName: data.subjectName || subjectName
        })

        // ÿ•ÿÆŸÅÿßÿ° popup ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸä
        setTimeout(() => {
          setSavePopup(prev => ({ ...prev, show: false }))
        }, 3000)
      } else {
        console.error("‚ùå Failed to save grades:", response.status, response.statusText)
        const errorData = await response.json()
        console.error("‚ùå Error details:", errorData)
      }
    } catch (error) {
      console.error("‚ùå Error saving grade:", error)
      // ÿ•ÿ∏Ÿáÿßÿ± popup ÿßŸÑÿÆÿ∑ÿ£
      setSavePopup({
        show: true,
        message: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™",
        subjectName: subjectName
      })

      setTimeout(() => {
        setSavePopup(prev => ({ ...prev, show: false }))
      }, 3000)
    }
  }, [filters.subject, filters.evaluationPeriod, filters.academicYear, isThirdPeriod])

  const updateStudentGrade = useCallback(
    (studentId: string, field: keyof Student, value: any) => {
      setStudents((prevStudents) =>
        prevStudents.map((student) => {
          if (student.studentId === studentId) {
            const updatedStudent = { ...student, [field]: value }

            if (["firstMonthGrade", "secondMonthGrade", "thirdMonthGrade"].includes(field)) {
              updatedStudent.workTotal = calculateWorkTotal(
                updatedStudent.firstMonthGrade,
                updatedStudent.secondMonthGrade,
                updatedStudent.thirdMonthGrade,
              )
              updatedStudent.periodTotal = calculatePeriodTotal(updatedStudent.workTotal, updatedStudent.finalExamGrade)
            }

            if (field === "finalExamGrade") {
              updatedStudent.periodTotal = calculatePeriodTotal(updatedStudent.workTotal, updatedStudent.finalExamGrade)
            }

            let isComplete = false
            if (isThirdPeriod) {
              isComplete =
                updatedStudent.firstMonthGrade !== null &&
                updatedStudent.secondMonthGrade !== null &&
                updatedStudent.finalExamGrade !== null
            } else {
              isComplete =
                updatedStudent.firstMonthGrade !== null &&
                updatedStudent.secondMonthGrade !== null &&
                updatedStudent.thirdMonthGrade !== null &&
                updatedStudent.finalExamGrade !== null
            }
            updatedStudent.status = isComplete ? "ŸÖŸÉÿ™ŸÖŸÑ" : "ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑ"

            // ÿ≠ŸÅÿ∏ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            console.log("üíæ Scheduling auto-save for student:", updatedStudent.studentName)
            setTimeout(() => {
              console.log("üíæ Executing auto-save for student:", updatedStudent.studentName)
              persistSingle(updatedStudent)
            }, 500) // ÿ™ÿ£ÿÆŸäÿ± 500ms ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©

            return updatedStudent
          }
          return student
        }),
      )
    },
    [calculateWorkTotal, calculatePeriodTotal, isThirdPeriod, persistSingle],
  )

  const filterStudents = useCallback(() => {
    let filtered = [...students]

    if (searchOptions.searchValue) {
      filtered = filtered.filter((student) => {
        switch (searchOptions.searchType) {
          case "name":
            return student.studentName.includes(searchOptions.searchValue)
          case "studentId":
            return student.studentId.includes(searchOptions.searchValue)
          default:
            return true
        }
      })
    }

    switch (searchOptions.displayFilter) {
      case "complete":
        filtered = filtered.filter((student) => student.status === "ŸÖŸÉÿ™ŸÖŸÑ")
        break
      case "incomplete":
        filtered = filtered.filter((student) => student.status === "ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑ")
        break
      default:
        break
    }

    setFilteredStudents(filtered)
  }, [students, searchOptions])

  useEffect(() => {
    filterStudents()
  }, [filterStudents])

  // ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ£Ÿà ÿπŸÜÿØ ÿ™ÿ∫ŸäŸëÿ± Ÿàÿßÿ∂ÿ≠
  useEffect(() => {
    fetchSubjectGrades()
  }, [fetchSubjectGrades])

  // Ÿàÿßÿ¨Ÿáÿ© ŸÑÿ™ŸÅÿπŸäŸÑ ÿ≤ÿ± "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿßÿ™ÿ±" ŸÖŸÜ ÿßŸÑŸÖŸÉŸàŸÜ
  const applyFilters = useCallback(() => {
    fetchSubjectGrades()
  }, [fetchSubjectGrades])

  // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÅÿ™ÿ±ÿ©
  useEffect(() => {
    if (filters.evaluationPeriod) {
      setStudents((prevStudents) =>
        prevStudents.map((student) => {
          const updatedStudent = { ...student }
          updatedStudent.workTotal = calculateWorkTotal(
            student.firstMonthGrade,
            student.secondMonthGrade,
            student.thirdMonthGrade,
          )
          updatedStudent.periodTotal = calculatePeriodTotal(updatedStudent.workTotal, student.finalExamGrade)

          // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©
          let isComplete = false
          if (isThirdPeriod) {
            isComplete =
              student.firstMonthGrade !== null &&
              student.secondMonthGrade !== null &&
              student.finalExamGrade !== null
          } else {
            isComplete =
              student.firstMonthGrade !== null &&
              student.secondMonthGrade !== null &&
              student.thirdMonthGrade !== null &&
              student.finalExamGrade !== null
          }
          updatedStudent.status = isComplete ? "ŸÖŸÉÿ™ŸÖŸÑ" : "ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑ"

          return updatedStudent
        }),
      )
    }
  }, [filters.evaluationPeriod, calculateWorkTotal, calculatePeriodTotal, isThirdPeriod])

  const getGradeColor = (grade: number | null): string => {
    if (grade === null) return "text-gray-400"
    if (grade >= 85) return "text-green-600"
    if (grade >= 50) return "text-yellow-600"
    return "text-red-600"
  }

  const getGradeBgColor = (grade: number | null): string => {
    if (grade === null) return "bg-gray-50"
    if (grade >= 85) return "bg-green-50"
    if (grade >= 50) return "bg-yellow-50"
    return "bg-red-50"
  }

  const stats = {
    total: students.length,
    complete: students.filter((s) => s.status === "ŸÖŸÉÿ™ŸÖŸÑ").length,
    incomplete: students.filter((s) => s.status === "ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑ").length,
    excellent: students.filter((s) => s.periodTotal >= 85).length,
    needsAttention: students.filter((s) => s.periodTotal < 50 && s.periodTotal > 0).length,
  }

  return {
    students: filteredStudents,
    filters,
    setFilters: setFiltersWithLog,
    applyFilters,
    searchOptions,
    setSearchOptions,
    updateStudentGrade,
    getGradeColor,
    getGradeBgColor,
    stats,
    isThirdPeriod,
    savePopup,
    setSavePopup,
  }
}
